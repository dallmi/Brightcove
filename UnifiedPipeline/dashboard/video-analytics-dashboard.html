<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Analytics Dashboard</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- DuckDB WASM -->
    <script type="module">
        import * as duckdb from 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/+esm';
        window.duckdb = duckdb;
        window.dispatchEvent(new Event('duckdb-ready'));
    </script>

    <style>
        :root {
            --primary: #1a73e8;
            --primary-dark: #1557b0;
            --primary-light: #4285f4;
            --black: #000000;
            --dark-gray: #333333;
            --medium-gray: #666666;
            --light-gray: #E5E5E5;
            --lighter-gray: #F5F5F5;
            --white: #FFFFFF;
            --success: #00875A;
            --success-light: #E3FCEF;
            --warning: #FF8B00;
            --warning-light: #FFFAE6;
            --danger: #DE350B;
            --danger-light: #FFEBE6;
            --info: #0052CC;
            --info-light: #DEEBFF;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--lighter-gray);
            color: var(--dark-gray);
            line-height: 1.5;
        }

        .header {
            background: var(--white);
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--light-gray);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            padding-left: 0.75rem;
            border-left: 3px solid var(--primary);
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .date-filter {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .date-filter label {
            font-size: 0.8rem;
            color: var(--medium-gray);
        }

        .date-filter input {
            padding: 0.4rem 0.5rem;
            border: 1px solid var(--light-gray);
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .btn {
            padding: 0.4rem 0.75rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover { background: var(--primary-dark); }

        .btn-secondary {
            background: transparent;
            color: var(--dark-gray);
            border: 1px solid var(--light-gray);
        }

        .btn-secondary:hover { background: var(--light-gray); }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 0;
            background: var(--white);
            border-radius: 8px 8px 0 0;
            border-bottom: 2px solid var(--light-gray);
            overflow-x: auto;
        }

        .nav-tab {
            padding: 0.75rem 1.25rem;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--medium-gray);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .nav-tab:hover {
            color: var(--dark-gray);
            background: var(--lighter-gray);
        }

        .nav-tab.active {
            color: var(--black);
            border-bottom-color: var(--primary);
        }

        .nav-content {
            display: none;
            background: var(--white);
            border-radius: 0 0 8px 8px;
            padding: 1rem;
        }

        .nav-content.active { display: block; }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            gap: 1rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--light-gray);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            color: var(--medium-gray);
            font-size: 0.85rem;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .kpi-card {
            background: var(--white);
            border-radius: 6px;
            padding: 1rem;
            border: 1px solid var(--light-gray);
            position: relative;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            border-radius: 6px 6px 0 0;
        }

        .kpi-card.highlight::before { background: var(--primary); }
        .kpi-card.success::before { background: var(--success); }
        .kpi-card.warning::before { background: var(--warning); }
        .kpi-card.info::before { background: var(--info); }

        .kpi-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: var(--medium-gray);
            margin-bottom: 0.25rem;
        }

        .kpi-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--black);
            line-height: 1.2;
        }

        .kpi-subtitle {
            font-size: 0.65rem;
            color: var(--medium-gray);
            margin-top: 0.25rem;
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .chart-card {
            background: var(--white);
            border-radius: 6px;
            padding: 1rem;
            border: 1px solid var(--light-gray);
        }

        .chart-card.full-width { grid-column: 1 / -1; }

        .chart-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-subtitle {
            font-size: 0.7rem;
            color: var(--medium-gray);
            font-weight: 400;
        }

        .chart-container { height: 250px; position: relative; }
        .chart-container.tall { height: 350px; }
        .chart-container.short { height: 180px; }

        /* Tables */
        .table-container {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        th {
            background: var(--lighter-gray);
            padding: 0.6rem 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark-gray);
            border-bottom: 1px solid var(--light-gray);
            position: sticky;
            top: 0;
            z-index: 1;
            cursor: pointer;
        }

        th:hover { background: var(--light-gray); }

        td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--light-gray);
            color: var(--dark-gray);
        }

        tr:hover td { background: var(--lighter-gray); }

        .text-right { text-align: right; }

        .badge {
            display: inline-block;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success { background: var(--success-light); color: var(--success); }
        .badge-warning { background: var(--warning-light); color: var(--warning); }
        .badge-danger { background: var(--danger-light); color: var(--danger); }
        .badge-info { background: var(--info-light); color: var(--info); }

        /* Search */
        .search-input {
            flex: 1;
            max-width: 400px;
            padding: 0.4rem 0.75rem;
            border: 1px solid var(--light-gray);
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .table-controls {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            align-items: center;
        }

        /* Executive Summary */
        .executive-summary {
            background: linear-gradient(135deg, var(--white) 0%, var(--lighter-gray) 100%);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid var(--light-gray);
        }

        .summary-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 0.75rem;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 0.75rem;
        }

        .insight-card {
            background: var(--white);
            border-radius: 6px;
            padding: 0.75rem;
            border-left: 3px solid var(--info);
        }

        .insight-card.positive { border-left-color: var(--success); }
        .insight-card.negative { border-left-color: var(--danger); }
        .insight-card.warning { border-left-color: var(--warning); }

        .insight-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 0.25rem;
        }

        .insight-text {
            font-size: 0.75rem;
            color: var(--medium-gray);
            line-height: 1.4;
        }

        /* Status bar */
        .status-bar {
            font-size: 0.7rem;
            color: var(--medium-gray);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-dot.loading { background: var(--warning); }
        .status-dot.error { background: var(--danger); }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-gray);
            margin: 1rem 0 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--light-gray);
        }

        /* Filter bar */
        .filter-bar {
            background: var(--white);
            padding: 0.6rem 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            border-bottom: 1px solid var(--light-gray);
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            gap: 0.4rem;
            align-items: center;
        }

        .filter-group label {
            font-size: 0.75rem;
            color: var(--medium-gray);
            font-weight: 500;
        }

        .filter-group select {
            padding: 0.35rem 0.5rem;
            border: 1px solid var(--light-gray);
            border-radius: 4px;
            font-size: 0.8rem;
            min-width: 160px;
        }

        .filter-group select:focus,
        .filter-group .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .active-filters {
            display: flex;
            gap: 0.4rem;
            align-items: center;
            flex-wrap: wrap;
            margin-left: auto;
        }

        .filter-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.2rem 0.5rem;
            background: var(--info-light);
            color: var(--info);
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .filter-tag .remove {
            cursor: pointer;
            font-weight: 700;
            font-size: 0.8rem;
            line-height: 1;
        }

        .filter-tag .remove:hover { color: var(--danger); }

        /* Responsive */
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 0.5rem; padding: 0.5rem 1rem; }
            .charts-grid { grid-template-columns: 1fr; }
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .nav-tabs { overflow-x: auto; }
            .date-filter { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>Video Analytics Dashboard</h1>
        <div class="header-controls">
            <div class="date-filter">
                <label>From:</label>
                <input type="date" id="dateFrom">
                <label>To:</label>
                <input type="date" id="dateTo">
                <button class="btn btn-primary" onclick="applyDateFilter()">Apply</button>
                <button class="btn btn-secondary" onclick="resetDateFilter()">Reset</button>
            </div>
            <div class="status-bar">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Initializing...</span>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Initializing DuckDB...</div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" style="display: none;">
            <div class="nav-tabs">
                <button class="nav-tab active" data-nav="overview">Overview</button>
                <button class="nav-tab" data-nav="content">Content</button>
                <button class="nav-tab" data-nav="channels">Channels</button>
                <button class="nav-tab" data-nav="devices">Devices</button>
                <button class="nav-tab" data-nav="lifecycle">Lifecycle</button>
                <button class="nav-tab" data-nav="explore">Explore</button>
            </div>

            <!-- Global Filters -->
            <div class="filter-bar" id="filterBar">
                <div class="filter-group">
                    <label>Channel:</label>
                    <select id="channelFilter" onchange="applyFilters()">
                        <option value="">All Channels</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Video:</label>
                    <input type="text" class="search-input" id="videoSearch" placeholder="Search by name..." oninput="debounceApplyFilters()">
                </div>
                <div id="activeFilters" class="active-filters"></div>
            </div>

            <!-- Overview Tab -->
            <div class="nav-content active" id="nav-overview">
                <div id="executiveSummary"></div>
                <div id="kpiCards" class="kpi-grid"></div>
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-title">Monthly Views</div>
                        <div class="chart-container"><canvas id="chartMonthlyViews"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Monthly Engagement <span class="chart-subtitle">excl. Internet autoplay</span></div>
                        <div class="chart-container"><canvas id="chartMonthlyEngagement"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Engagement Funnel <span class="chart-subtitle">excl. Internet</span></div>
                        <div class="chart-container tall"><canvas id="chartFunnel"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Views by Channel</div>
                        <div class="chart-container tall"><canvas id="chartChannelViews"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Content Tab -->
            <div class="nav-content" id="nav-content">
                <h3 class="section-title">Duration Sweet Spot</h3>
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-title">Completion Rate by Duration <span class="chart-subtitle">excl. Internet</span></div>
                        <div class="chart-container"><canvas id="chartDurationCompletion"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Total Views by Duration</div>
                        <div class="chart-container"><canvas id="chartDurationViews"></canvas></div>
                    </div>
                </div>
                <h3 class="section-title">Top Videos by Views</h3>
                <div id="topVideosByViews"></div>
                <h3 class="section-title">Top Videos by Engagement (min. 100 views, excl. Internet)</h3>
                <div id="topVideosByEngagement"></div>
                <h3 class="section-title">Low Play Rate Videos</h3>
                <p style="font-size:0.75rem; color:var(--medium-gray); margin-bottom:0.5rem;">High impressions but low play rate -- may need better thumbnails or titles.</p>
                <div id="lowPlayRate"></div>
            </div>

            <!-- Channels Tab -->
            <div class="nav-content" id="nav-channels">
                <h3 class="section-title">Channel Performance</h3>
                <div id="channelTable"></div>
                <div class="charts-grid" style="margin-top:1rem;">
                    <div class="chart-card">
                        <div class="chart-title">Views per Video by Channel</div>
                        <div class="chart-container tall"><canvas id="chartChannelEfficiency"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Engagement by Channel <span class="chart-subtitle">excl. Internet</span></div>
                        <div class="chart-container tall"><canvas id="chartChannelEngagement"></canvas></div>
                    </div>
                </div>
                <h3 class="section-title">Engagement Funnel by Channel (excl. Internet)</h3>
                <div id="channelFunnelTable"></div>
            </div>

            <!-- Devices Tab -->
            <div class="nav-content" id="nav-devices">
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-title">Views by Device Type</div>
                        <div class="chart-container tall"><canvas id="chartDevicePie"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Device Breakdown</div>
                        <div class="chart-container tall"><canvas id="chartDeviceBar"></canvas></div>
                    </div>
                    <div class="chart-card full-width">
                        <div class="chart-title">Mobile vs Desktop Trend</div>
                        <div class="chart-container"><canvas id="chartDeviceTrend"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Lifecycle Tab -->
            <div class="nav-content" id="nav-lifecycle">
                <h3 class="section-title">Stale Content (Not viewed in 180+ days)</h3>
                <p style="font-size:0.75rem; color:var(--medium-gray); margin-bottom:0.5rem;">Videos that once had audience interest but haven't been viewed recently. Candidates for archival or refresh.</p>
                <div id="staleContent"></div>
                <h3 class="section-title">Top Performers (Last 30 Days)</h3>
                <div id="recentPerformers"></div>
            </div>

            <!-- Explore Tab -->
            <div class="nav-content" id="nav-explore">
                <div id="exploreTable"></div>
            </div>
        </div>
    </div>

    <script>
        // ====================================================================
        // GLOBALS
        // ====================================================================
        let db, conn;
        let dateFilter = { from: null, to: null };
        let channelFilterValue = '';
        let videoSearchValue = '';
        let debounceTimer = null;
        let charts = {};
        let allChannels = [];

        const COLORS = {
            primary: '#1a73e8',
            primaryLight: '#4285f4',
            success: '#00875A',
            warning: '#FF8B00',
            danger: '#DE350B',
            info: '#0052CC',
            gray: '#999999',
            palette: [
                '#1a73e8', '#e74c3c', '#2ecc71', '#9b59b6', '#f39c12',
                '#1abc9c', '#e67e22', '#3498db', '#e91e63', '#00bcd4',
                '#ff5722'
            ]
        };

        // ====================================================================
        // HELPERS
        // ====================================================================
        function fmt(n) {
            if (n == null || isNaN(n)) return '-';
            return Number(n).toLocaleString('en-US', { maximumFractionDigits: 0 });
        }

        function fmtPct(n) {
            if (n == null || isNaN(n)) return '-';
            return Number(n).toFixed(1) + '%';
        }

        function fmtDuration(seconds) {
            if (seconds == null || isNaN(seconds)) return '-';
            const m = Math.floor(seconds / 60);
            const s = Math.round(seconds % 60);
            return m > 0 ? `${m}m ${s}s` : `${s}s`;
        }

        function updateStatus(state, text) {
            const dot = document.getElementById('statusDot');
            const txt = document.getElementById('statusText');
            dot.className = 'status-dot' + (state === 'loading' ? ' loading' : state === 'error' ? ' error' : '');
            txt.textContent = text;
        }

        function setLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        function destroyChart(id) {
            if (charts[id]) { charts[id].destroy(); delete charts[id]; }
        }

        function getWhereClause(col = 'date') {
            const parts = ['1=1'];
            if (dateFilter.from && dateFilter.to) {
                parts.push(`${col} >= '${dateFilter.from}' AND ${col} <= '${dateFilter.to}'`);
            }
            if (channelFilterValue) {
                parts.push(`channel = '${channelFilterValue.replace(/'/g, "''")}'`);
            }
            if (videoSearchValue.length >= 2) {
                parts.push(`name ILIKE '%${videoSearchValue.replace(/'/g, "''")}%'`);
            }
            return parts.join(' AND ');
        }

        // When user explicitly picks a channel, don't auto-exclude Internet
        function shouldExcludeInternet() {
            return !channelFilterValue;
        }

        function internetClause() {
            return shouldExcludeInternet() ? "${internetClause()}" : '';
        }

        function truncateStr(s, maxLen = 60) {
            if (!s) return '';
            return s.length > maxLen ? s.substring(0, maxLen) + '...' : s;
        }

        async function query(sql) {
            const result = await conn.query(sql);
            return result.toArray().map(row => {
                const obj = {};
                for (const key of Object.keys(row)) {
                    let v = row[key];
                    if (typeof v === 'bigint') v = Number(v);
                    obj[key] = v;
                }
                return obj;
            });
        }

        // ====================================================================
        // TAB NAVIGATION
        // ====================================================================
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.nav-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('nav-' + tab.dataset.nav).classList.add('active');
            });
        });

        // ====================================================================
        // INIT
        // ====================================================================
        async function init() {
            try {
                updateStatus('loading', 'Waiting for DuckDB...');

                if (!window.duckdb) {
                    await new Promise(resolve => {
                        window.addEventListener('duckdb-ready', resolve, { once: true });
                    });
                }

                updateStatus('loading', 'Initializing DuckDB...');
                setLoadingText('Initializing DuckDB...');

                const duckdbModule = window.duckdb;
                const JSDELIVR_BUNDLES = duckdbModule.getJsDelivrBundles();
                const bundle = await duckdbModule.selectBundle(JSDELIVR_BUNDLES);
                const worker_url = URL.createObjectURL(
                    new Blob([`importScripts("${bundle.mainWorker}");`], { type: 'text/javascript' })
                );
                const worker = new Worker(worker_url);
                const logger = new duckdbModule.ConsoleLogger();
                db = new duckdbModule.AsyncDuckDB(logger, worker);
                await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
                URL.revokeObjectURL(worker_url);

                conn = await db.connect();

                setLoadingText('Loading parquet files...');
                await loadParquetFiles();

                await setInitialDateRange();

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';

                await renderDashboard();

                updateStatus('success', `Loaded: ${new Date().toLocaleTimeString()}`);
            } catch (error) {
                console.error('Init error:', error);
                setLoadingText(`Failed to initialize: ${error.message}`);
                updateStatus('error', 'Error loading data');
            }
        }

        async function loadParquetFiles() {
            const baseUrl = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '');
            const pathsToTry = [
                `${baseUrl}/../output/parquet/`,
                `${window.location.origin}/output/parquet/`,
                `${baseUrl}/output/parquet/`
            ];

            async function fetchAndRegister(fileName, relativePath, statusText) {
                let lastError;
                for (const basePath of pathsToTry) {
                    try {
                        const fullPath = basePath + relativePath;
                        setLoadingText(`Fetching ${fileName}...`);
                        const response = await fetch(fullPath);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        const buffer = await response.arrayBuffer();
                        await db.registerFileBuffer(fileName, new Uint8Array(buffer));
                        await conn.query(`CREATE VIEW ${fileName.replace('.parquet', '')} AS SELECT * FROM read_parquet('${fileName}')`);
                        setLoadingText(statusText);
                        return;
                    } catch (e) {
                        lastError = e;
                    }
                }
                throw new Error(`Could not load ${relativePath}: ${lastError?.message}`);
            }

            await fetchAndRegister('facts.parquet', 'facts/daily_analytics_all.parquet', 'Loaded daily analytics...');
            await fetchAndRegister('dims.parquet', 'dimensions/video_metadata.parquet', 'Loaded video metadata...');

            // Create joined view for convenience
            setLoadingText('Creating analytics view...');
            await conn.query(`
                CREATE VIEW analytics AS
                SELECT
                    f.*,
                    d.channel,
                    d.name,
                    d.account_id,
                    d.video_duration,
                    COALESCE(d.video_duration_seconds, d.video_duration / 1000.0) as video_duration_seconds,
                    d.created_at,
                    d.published_at,
                    d.video_content_type,
                    d.video_category,
                    d.country,
                    d.language
                FROM facts f
                JOIN dims d ON f.video_id = d.video_id
            `);
        }

        async function setInitialDateRange() {
            const result = await query(`SELECT MIN(date) as min_date, MAX(date) as max_date FROM facts`);
            const row = result[0];
            const minDate = new Date(row.min_date);
            const maxDate = new Date(row.max_date);

            document.getElementById('dateFrom').value = minDate.toISOString().split('T')[0];
            document.getElementById('dateTo').value = maxDate.toISOString().split('T')[0];

            dateFilter.from = document.getElementById('dateFrom').value;
            dateFilter.to = document.getElementById('dateTo').value;
        }

        async function applyDateFilter() {
            dateFilter.from = document.getElementById('dateFrom').value;
            dateFilter.to = document.getElementById('dateTo').value;
            if (dateFilter.from && dateFilter.to) {
                updateActiveFilters();
                await renderDashboard();
            }
        }

        async function resetDateFilter() {
            await setInitialDateRange();
            channelFilterValue = '';
            videoSearchValue = '';
            document.getElementById('channelFilter').value = '';
            document.getElementById('videoSearch').value = '';
            updateActiveFilters();
            await renderDashboard();
        }

        async function applyFilters() {
            channelFilterValue = document.getElementById('channelFilter').value;
            videoSearchValue = document.getElementById('videoSearch').value.trim();
            updateActiveFilters();
            await renderDashboard();
        }

        function debounceApplyFilters() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => applyFilters(), 400);
        }

        function updateActiveFilters() {
            const el = document.getElementById('activeFilters');
            const tags = [];
            if (channelFilterValue) {
                tags.push(`<span class="filter-tag">${channelFilterValue} <span class="remove" onclick="clearFilter('channel')">x</span></span>`);
            }
            if (videoSearchValue.length >= 2) {
                tags.push(`<span class="filter-tag">"${videoSearchValue}" <span class="remove" onclick="clearFilter('video')">x</span></span>`);
            }
            el.innerHTML = tags.join('');
        }

        async function clearFilter(type) {
            if (type === 'channel') {
                channelFilterValue = '';
                document.getElementById('channelFilter').value = '';
            } else if (type === 'video') {
                videoSearchValue = '';
                document.getElementById('videoSearch').value = '';
            }
            updateActiveFilters();
            await renderDashboard();
        }

        // ====================================================================
        // RENDER DASHBOARD
        // ====================================================================
        async function renderDashboard() {
            updateStatus('loading', 'Refreshing...');
            try {
                await Promise.all([
                    renderExecutiveSummary(),
                    renderKPIs(),
                    renderMonthlyViews(),
                    renderMonthlyEngagement(),
                    renderFunnel(),
                    renderChannelViews(),
                    renderDurationCompletion(),
                    renderDurationViews(),
                    renderTopVideosByViews(),
                    renderTopVideosByEngagement(),
                    renderLowPlayRate(),
                    renderChannelTable(),
                    renderChannelEfficiency(),
                    renderChannelEngagement(),
                    renderChannelFunnel(),
                    renderDevicePie(),
                    renderDeviceBar(),
                    renderDeviceTrend(),
                    renderStaleContent(),
                    renderRecentPerformers(),
                    renderExploreTable(),
                    populateChannelFilter()
                ]);
                updateStatus('success', `Updated: ${new Date().toLocaleTimeString()}`);
            } catch (error) {
                console.error('Render error:', error);
                updateStatus('error', 'Error rendering dashboard');
            }
        }

        // ====================================================================
        // EXECUTIVE SUMMARY
        // ====================================================================
        async function renderExecutiveSummary() {
            const w = getWhereClause();
            const data = await query(`
                SELECT
                    SUM(video_view) as total_views,
                    COUNT(DISTINCT video_id) as total_videos,
                    COUNT(DISTINCT channel) as total_channels
                FROM analytics
                WHERE ${w}
            `);

            const engData = await query(`
                SELECT
                    ROUND(SUM(video_engagement_100) * 100.0 / NULLIF(SUM(video_view), 0), 1) as avg_completion,
                    ROUND(SUM(views_mobile) * 100.0 / NULLIF(SUM(video_view), 0), 1) as mobile_pct
                FROM analytics
                WHERE ${w} ${internetClause()}
            `);

            const row = data[0];
            const eng = engData[0];

            const insights = [];

            if (row.total_views > 0) {
                insights.push({
                    cls: 'positive',
                    title: 'Scale',
                    text: `${fmt(row.total_views)} total views across ${fmt(row.total_videos)} videos on ${row.total_channels} channels.`
                });
            }

            if (eng.avg_completion != null) {
                const cls = eng.avg_completion > 50 ? 'positive' : eng.avg_completion > 30 ? 'warning' : 'negative';
                insights.push({
                    cls,
                    title: 'Completion Rate',
                    text: `${fmtPct(eng.avg_completion)} of viewers watch videos to the end (excl. Internet autoplay).`
                });
            }

            if (eng.mobile_pct != null) {
                insights.push({
                    cls: eng.mobile_pct > 30 ? 'warning' : '',
                    title: 'Mobile Viewing',
                    text: `${fmtPct(eng.mobile_pct)} of views come from mobile devices.${eng.mobile_pct > 30 ? ' Consider mobile-optimized content.' : ''}`
                });
            }

            const el = document.getElementById('executiveSummary');
            el.innerHTML = `
                <div class="executive-summary">
                    <div class="summary-title">Executive Summary</div>
                    <div class="insights-grid">
                        ${insights.map(i => `
                            <div class="insight-card ${i.cls}">
                                <div class="insight-title">${i.title}</div>
                                <div class="insight-text">${i.text}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ====================================================================
        // KPIs
        // ====================================================================
        async function renderKPIs() {
            const w = getWhereClause();
            const data = await query(`
                SELECT
                    SUM(video_view) as total_views,
                    COUNT(DISTINCT video_id) as total_videos,
                    COUNT(DISTINCT channel) as total_channels,
                    ROUND(SUM(video_seconds_viewed) / 3600.0, 0) as watch_hours,
                    SUM(video_impression) as total_impressions
                FROM analytics
                WHERE ${w}
            `);

            const engData = await query(`
                SELECT
                    ROUND(SUM(video_engagement_100) * 100.0 / NULLIF(SUM(video_view), 0), 1) as completion_rate,
                    ROUND(SUM(video_engagement_25) * 100.0 / NULLIF(SUM(video_view), 0), 1) as reached_25
                FROM analytics
                WHERE ${w} ${internetClause()}
            `);

            const row = data[0];
            const eng = engData[0];

            document.getElementById('kpiCards').innerHTML = `
                <div class="kpi-card highlight">
                    <div class="kpi-label">Total Views</div>
                    <div class="kpi-value">${fmt(row.total_views)}</div>
                </div>
                <div class="kpi-card info">
                    <div class="kpi-label">Videos Tracked</div>
                    <div class="kpi-value">${fmt(row.total_videos)}</div>
                </div>
                <div class="kpi-card info">
                    <div class="kpi-label">Channels</div>
                    <div class="kpi-value">${row.total_channels}</div>
                </div>
                <div class="kpi-card success">
                    <div class="kpi-label">Watch Hours</div>
                    <div class="kpi-value">${fmt(row.watch_hours)}</div>
                </div>
                <div class="kpi-card warning">
                    <div class="kpi-label">Impressions</div>
                    <div class="kpi-value">${fmt(row.total_impressions)}</div>
                </div>
                <div class="kpi-card ${eng.completion_rate > 50 ? 'success' : 'warning'}">
                    <div class="kpi-label">Completion Rate</div>
                    <div class="kpi-value">${fmtPct(eng.completion_rate)}</div>
                    <div class="kpi-subtitle">excl. Internet</div>
                </div>
            `;
        }

        // ====================================================================
        // MONTHLY VIEWS
        // ====================================================================
        async function renderMonthlyViews() {
            const w = getWhereClause();
            const data = await query(`
                SELECT
                    DATE_TRUNC('month', date)::VARCHAR as month,
                    SUM(video_view) as views
                FROM analytics
                WHERE ${w}
                  AND DATE_TRUNC('month', date) < DATE_TRUNC('month', CURRENT_DATE)
                GROUP BY 1 ORDER BY 1
            `);

            destroyChart('chartMonthlyViews');
            const ctx = document.getElementById('chartMonthlyViews').getContext('2d');
            charts['chartMonthlyViews'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(r => r.month.substring(0, 7)),
                    datasets: [{
                        data: data.map(r => r.views),
                        backgroundColor: COLORS.primary + '99',
                        borderColor: COLORS.primary,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: v => fmt(v) } },
                        x: { ticks: { maxRotation: 45 } }
                    }
                }
            });
        }

        // ====================================================================
        // MONTHLY ENGAGEMENT
        // ====================================================================
        async function renderMonthlyEngagement() {
            const w = getWhereClause();
            const data = await query(`
                SELECT
                    DATE_TRUNC('month', date)::VARCHAR as month,
                    ROUND(SUM(video_engagement_100) * 100.0 / NULLIF(SUM(video_view), 0), 1) as completion,
                    ROUND(SUM(video_engagement_50) * 100.0 / NULLIF(SUM(video_view), 0), 1) as halfway
                FROM analytics
                WHERE ${w}
                  ${internetClause()}
                  AND DATE_TRUNC('month', date) < DATE_TRUNC('month', CURRENT_DATE)
                GROUP BY 1 ORDER BY 1
            `);

            destroyChart('chartMonthlyEngagement');
            const ctx = document.getElementById('chartMonthlyEngagement').getContext('2d');
            charts['chartMonthlyEngagement'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(r => r.month.substring(0, 7)),
                    datasets: [
                        {
                            label: 'Reached 50%',
                            data: data.map(r => r.halfway),
                            borderColor: COLORS.warning,
                            backgroundColor: COLORS.warning + '20',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Completed',
                            data: data.map(r => r.completion),
                            borderColor: COLORS.success,
                            backgroundColor: COLORS.success + '20',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } },
                        x: { ticks: { maxRotation: 45 } }
                    }
                }
            });
        }

        // ====================================================================
        // ENGAGEMENT FUNNEL
        // ====================================================================
        async function renderFunnel() {
            const w = getWhereClause();
            const data = await query(`
                SELECT
                    ROUND(SUM(video_engagement_1) * 100.0 / NULLIF(SUM(video_view), 0), 1) as started,
                    ROUND(SUM(video_engagement_25) * 100.0 / NULLIF(SUM(video_view), 0), 1) as reached_25,
                    ROUND(SUM(video_engagement_50) * 100.0 / NULLIF(SUM(video_view), 0), 1) as reached_50,
                    ROUND(SUM(video_engagement_75) * 100.0 / NULLIF(SUM(video_view), 0), 1) as reached_75,
                    ROUND(SUM(video_engagement_100) * 100.0 / NULLIF(SUM(video_view), 0), 1) as completed
                FROM analytics
                WHERE ${w} ${internetClause()}
            `);

            const row = data[0];
            const labels = ['Completed (100%)', 'Reached 75%', 'Reached 50%', 'Reached 25%', 'Started (1%)'];
            const values = [row.completed, row.reached_75, row.reached_50, row.reached_25, row.started];
            const colors = ['#2ecc71', '#3498db', '#9b59b6', '#e74c3c', '#f39c12'];

            destroyChart('chartFunnel');
            const ctx = document.getElementById('chartFunnel').getContext('2d');
            charts['chartFunnel'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.reverse(),
                        borderWidth: 0
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: ctx => fmtPct(ctx.raw) } }
                    },
                    scales: {
                        x: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } }
                    }
                }
            });
        }

        // ====================================================================
        // CHANNEL VIEWS (Overview)
        // ====================================================================
        async function renderChannelViews() {
            const w = getWhereClause();
            const data = await query(`
                SELECT channel, SUM(video_view) as views
                FROM analytics
                WHERE ${w}
                GROUP BY channel
                ORDER BY views DESC
            `);

            destroyChart('chartChannelViews');
            const ctx = document.getElementById('chartChannelViews').getContext('2d');
            charts['chartChannelViews'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(r => r.channel),
                    datasets: [{
                        data: data.map(r => r.views),
                        backgroundColor: data.map((_, i) => COLORS.palette[i % COLORS.palette.length] + '99'),
                        borderColor: data.map((_, i) => COLORS.palette[i % COLORS.palette.length]),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, ticks: { callback: v => fmt(v) } }
                    }
                }
            });
        }

        // ====================================================================
        // DURATION SWEET SPOT
        // ====================================================================
        async function renderDurationCompletion() {
            const w = getWhereClause();
            const data = await query(`
                SELECT
                    CASE
                        WHEN video_duration_seconds <= 60 THEN '0-1 min'
                        WHEN video_duration_seconds <= 120 THEN '1-2 min'
                        WHEN video_duration_seconds <= 180 THEN '2-3 min'
                        WHEN video_duration_seconds <= 300 THEN '3-5 min'
                        WHEN video_duration_seconds <= 600 THEN '5-10 min'
                        WHEN video_duration_seconds <= 900 THEN '10-15 min'
                        ELSE '15+ min'
                    END as bucket,
                    CASE
                        WHEN video_duration_seconds <= 60 THEN 1
                        WHEN video_duration_seconds <= 120 THEN 2
                        WHEN video_duration_seconds <= 180 THEN 3
                        WHEN video_duration_seconds <= 300 THEN 4
                        WHEN video_duration_seconds <= 600 THEN 5
                        WHEN video_duration_seconds <= 900 THEN 6
                        ELSE 7
                    END as sort_order,
                    ROUND(SUM(video_engagement_100) * 100.0 / NULLIF(SUM(video_view), 0), 1) as completion
                FROM analytics
                WHERE ${w} AND video_duration_seconds > 0 AND video_view > 0 ${internetClause()}
                GROUP BY 1, 2 ORDER BY sort_order
            `);

            destroyChart('chartDurationCompletion');
            const ctx = document.getElementById('chartDurationCompletion').getContext('2d');
            charts['chartDurationCompletion'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(r => r.bucket),
                    datasets: [{
                        data: data.map(r => r.completion),
                        backgroundColor: data.map(r => r.completion > 50 ? COLORS.success + '99' : r.completion > 30 ? COLORS.warning + '99' : COLORS.danger + '99'),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: ctx => fmtPct(ctx.raw) } }
                    },
                    scales: {
                        y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } },
                        x: { ticks: { maxRotation: 45 } }
                    }
                }
            });
        }

        async function renderDurationViews() {
            const w = getWhereClause();
            const data = await query(`
                SELECT
                    CASE
                        WHEN video_duration_seconds <= 60 THEN '0-1 min'
                        WHEN video_duration_seconds <= 120 THEN '1-2 min'
                        WHEN video_duration_seconds <= 180 THEN '2-3 min'
                        WHEN video_duration_seconds <= 300 THEN '3-5 min'
                        WHEN video_duration_seconds <= 600 THEN '5-10 min'
                        WHEN video_duration_seconds <= 900 THEN '10-15 min'
                        ELSE '15+ min'
                    END as bucket,
                    CASE
                        WHEN video_duration_seconds <= 60 THEN 1
                        WHEN video_duration_seconds <= 120 THEN 2
                        WHEN video_duration_seconds <= 180 THEN 3
                        WHEN video_duration_seconds <= 300 THEN 4
                        WHEN video_duration_seconds <= 600 THEN 5
                        WHEN video_duration_seconds <= 900 THEN 6
                        ELSE 7
                    END as sort_order,
                    SUM(video_view) as views,
                    COUNT(DISTINCT video_id) as num_videos
                FROM analytics
                WHERE ${w} AND video_duration_seconds > 0 AND video_view > 0
                GROUP BY 1, 2 ORDER BY sort_order
            `);

            destroyChart('chartDurationViews');
            const ctx = document.getElementById('chartDurationViews').getContext('2d');
            charts['chartDurationViews'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(r => r.bucket),
                    datasets: [{
                        label: 'Views',
                        data: data.map(r => r.views),
                        backgroundColor: COLORS.primary + '99',
                        borderColor: COLORS.primary,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: (ctx) => `${fmt(data[ctx.dataIndex].num_videos)} videos`
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: v => fmt(v) } },
                        x: { ticks: { maxRotation: 45 } }
                    }
                }
            });
        }

        // ====================================================================
        // TOP VIDEOS BY VIEWS
        // ====================================================================
        async function renderTopVideosByViews() {
            const w = getWhereClause();
            const data = await query(`
                SELECT
                    channel,
                    video_id,
                    MAX(name) as name,
                    SUM(video_view) as views,
                    ROUND(SUM(video_engagement_100) * 100.0 / NULLIF(SUM(video_view), 0), 1) as completion
                FROM analytics
                WHERE ${w} AND video_view > 0
                GROUP BY channel, video_id
                ORDER BY views DESC
                LIMIT 20
            `);

            document.getElementById('topVideosByViews').innerHTML = renderTable(data, [
                { key: 'channel', label: 'Channel' },
                { key: 'name', label: 'Video Name', fmt: v => truncateStr(v, 70) },
                { key: 'views', label: 'Views', cls: 'text-right', fmt: fmt },
                { key: 'completion', label: 'Completion', cls: 'text-right', fmt: fmtPct }
            ]);
        }

        // ====================================================================
        // TOP VIDEOS BY ENGAGEMENT
        // ====================================================================
        async function renderTopVideosByEngagement() {
            const w = getWhereClause();
            const data = await query(`
                SELECT
                    channel,
                    video_id,
                    MAX(name) as name,
                    SUM(video_view) as views,
                    ROUND(SUM(video_engagement_100) * 100.0 / NULLIF(SUM(video_view), 0), 1) as completion,
                    ROUND(SUM(video_engagement_50) * 100.0 / NULLIF(SUM(video_view), 0), 1) as halfway
                FROM analytics
                WHERE ${w} AND video_view > 0 ${internetClause()}
                GROUP BY channel, video_id
                HAVING SUM(video_view) >= 100
                ORDER BY completion DESC
                LIMIT 20
            `);

            document.getElementById('topVideosByEngagement').innerHTML = renderTable(data, [
                { key: 'channel', label: 'Channel' },
                { key: 'name', label: 'Video Name', fmt: v => truncateStr(v, 70) },
                { key: 'views', label: 'Views', cls: 'text-right', fmt: fmt },
                { key: 'halfway', label: 'Reached 50%', cls: 'text-right', fmt: fmtPct },
                { key: 'completion', label: 'Completed', cls: 'text-right', fmt: fmtPct }
            ]);
        }

        // ====================================================================
        // LOW PLAY RATE VIDEOS
        // ====================================================================
        async function renderLowPlayRate() {
            const w = getWhereClause();
            const data = await query(`
                SELECT
                    channel,
                    video_id,
                    MAX(name) as name,
                    SUM(video_impression) as impressions,
                    SUM(video_view) as views,
                    ROUND(SUM(video_view) * 100.0 / NULLIF(SUM(video_impression), 0), 1) as play_rate
                FROM analytics
                WHERE ${w} AND video_impression > 0
                GROUP BY channel, video_id
                HAVING SUM(video_impression) >= 100
                ORDER BY play_rate ASC
                LIMIT 20
            `);

            document.getElementById('lowPlayRate').innerHTML = renderTable(data, [
                { key: 'channel', label: 'Channel' },
                { key: 'name', label: 'Video Name', fmt: v => truncateStr(v, 70) },
                { key: 'impressions', label: 'Impressions', cls: 'text-right', fmt: fmt },
                { key: 'views', label: 'Views', cls: 'text-right', fmt: fmt },
                { key: 'play_rate', label: 'Play Rate', cls: 'text-right', fmt: fmtPct }
            ]);
        }

        // ====================================================================
        // CHANNEL TABLE
        // ====================================================================
        async function renderChannelTable() {
            const w = getWhereClause();
            const data = await query(`
                SELECT
                    channel,
                    COUNT(DISTINCT video_id) as num_videos,
                    SUM(video_view) as views,
                    ROUND(SUM(video_view) * 1.0 / NULLIF(COUNT(DISTINCT video_id), 0), 0) as views_per_video,
                    ROUND(SUM(video_engagement_100) * 100.0 / NULLIF(SUM(video_view), 0), 1) as completion,
                    ROUND(SUM(views_mobile) * 100.0 / NULLIF(SUM(video_view), 0), 1) as mobile_pct
                FROM analytics
                WHERE ${w} AND video_view > 0
                GROUP BY channel
                ORDER BY views DESC
            `);

            document.getElementById('channelTable').innerHTML = renderTable(data, [
                { key: 'channel', label: 'Channel' },
                { key: 'num_videos', label: 'Videos', cls: 'text-right', fmt: fmt },
                { key: 'views', label: 'Total Views', cls: 'text-right', fmt: fmt },
                { key: 'views_per_video', label: 'Views/Video', cls: 'text-right', fmt: fmt },
                { key: 'completion', label: 'Completion', cls: 'text-right', fmt: fmtPct },
                { key: 'mobile_pct', label: 'Mobile %', cls: 'text-right', fmt: fmtPct }
            ]);
        }

        // ====================================================================
        // CHANNEL EFFICIENCY CHART
        // ====================================================================
        async function renderChannelEfficiency() {
            const w = getWhereClause();
            const data = await query(`
                SELECT
                    channel,
                    ROUND(SUM(video_view) * 1.0 / NULLIF(COUNT(DISTINCT video_id), 0), 0) as views_per_video
                FROM analytics
                WHERE ${w} AND video_view > 0
                GROUP BY channel
                ORDER BY views_per_video DESC
            `);

            destroyChart('chartChannelEfficiency');
            const ctx = document.getElementById('chartChannelEfficiency').getContext('2d');
            charts['chartChannelEfficiency'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(r => r.channel),
                    datasets: [{
                        data: data.map(r => r.views_per_video),
                        backgroundColor: data.map((_, i) => COLORS.palette[i % COLORS.palette.length] + '99'),
                        borderWidth: 0
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, ticks: { callback: v => fmt(v) } }
                    }
                }
            });
        }

        // ====================================================================
        // CHANNEL ENGAGEMENT CHART
        // ====================================================================
        async function renderChannelEngagement() {
            const w = getWhereClause();
            const data = await query(`
                SELECT
                    channel,
                    ROUND(SUM(video_engagement_100) * 100.0 / NULLIF(SUM(video_view), 0), 1) as completion
                FROM analytics
                WHERE ${w} AND video_view > 0 ${internetClause()}
                GROUP BY channel
                ORDER BY completion DESC
            `);

            destroyChart('chartChannelEngagement');
            const ctx = document.getElementById('chartChannelEngagement').getContext('2d');
            charts['chartChannelEngagement'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(r => r.channel),
                    datasets: [{
                        data: data.map(r => r.completion),
                        backgroundColor: data.map(r => r.completion > 50 ? COLORS.success + '99' : r.completion > 30 ? COLORS.warning + '99' : COLORS.danger + '99'),
                        borderWidth: 0
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: ctx => fmtPct(ctx.raw) } }
                    },
                    scales: {
                        x: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } }
                    }
                }
            });
        }

        // ====================================================================
        // CHANNEL FUNNEL TABLE
        // ====================================================================
        async function renderChannelFunnel() {
            const w = getWhereClause();
            const data = await query(`
                SELECT
                    channel,
                    ROUND(SUM(video_engagement_1) * 100.0 / NULLIF(SUM(video_view), 0), 1) as started,
                    ROUND(SUM(video_engagement_25) * 100.0 / NULLIF(SUM(video_view), 0), 1) as reached_25,
                    ROUND(SUM(video_engagement_50) * 100.0 / NULLIF(SUM(video_view), 0), 1) as reached_50,
                    ROUND(SUM(video_engagement_75) * 100.0 / NULLIF(SUM(video_view), 0), 1) as reached_75,
                    ROUND(SUM(video_engagement_100) * 100.0 / NULLIF(SUM(video_view), 0), 1) as completed
                FROM analytics
                WHERE ${w} AND video_view > 0 ${internetClause()}
                GROUP BY channel
                ORDER BY completed DESC
            `);

            document.getElementById('channelFunnelTable').innerHTML = renderTable(data, [
                { key: 'channel', label: 'Channel' },
                { key: 'started', label: 'Started', cls: 'text-right', fmt: fmtPct },
                { key: 'reached_25', label: '25%', cls: 'text-right', fmt: fmtPct },
                { key: 'reached_50', label: '50%', cls: 'text-right', fmt: fmtPct },
                { key: 'reached_75', label: '75%', cls: 'text-right', fmt: fmtPct },
                { key: 'completed', label: '100%', cls: 'text-right', fmt: fmtPct }
            ]);
        }

        // ====================================================================
        // DEVICE PIE
        // ====================================================================
        async function renderDevicePie() {
            const w = getWhereClause();
            const data = await query(`
                SELECT
                    SUM(views_desktop) as desktop,
                    SUM(views_mobile) as mobile,
                    SUM(views_tablet) as tablet,
                    SUM(views_other) as other_device
                FROM analytics
                WHERE ${w}
            `);

            const row = data[0];
            const labels = [];
            const values = [];
            const colors = ['#3498db', '#e74c3c', '#2ecc71', '#9b59b6'];

            if (row.desktop > 0) { labels.push('Desktop'); values.push(row.desktop); }
            if (row.mobile > 0) { labels.push('Mobile'); values.push(row.mobile); }
            if (row.tablet > 0) { labels.push('Tablet'); values.push(row.tablet); }
            if (row.other_device > 0) { labels.push('Other'); values.push(row.other_device); }

            destroyChart('chartDevicePie');
            const ctx = document.getElementById('chartDevicePie').getContext('2d');
            charts['chartDevicePie'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, values.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: ctx => {
                                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const pct = (ctx.raw / total * 100).toFixed(1);
                                    return `${ctx.label}: ${fmt(ctx.raw)} (${pct}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ====================================================================
        // DEVICE BAR
        // ====================================================================
        async function renderDeviceBar() {
            const w = getWhereClause();
            const data = await query(`
                SELECT
                    SUM(views_desktop) as desktop,
                    SUM(views_mobile) as mobile,
                    SUM(views_tablet) as tablet,
                    SUM(views_other) as other_device
                FROM analytics
                WHERE ${w}
            `);

            const row = data[0];
            const entries = [
                { label: 'Desktop', value: row.desktop },
                { label: 'Mobile', value: row.mobile },
                { label: 'Tablet', value: row.tablet },
                { label: 'Other', value: row.other_device }
            ].filter(e => e.value > 0);

            destroyChart('chartDeviceBar');
            const ctx = document.getElementById('chartDeviceBar').getContext('2d');
            charts['chartDeviceBar'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: entries.map(e => e.label),
                    datasets: [{
                        data: entries.map(e => e.value),
                        backgroundColor: ['#3498db99', '#e74c3c99', '#2ecc7199', '#9b59b699'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: v => fmt(v) } }
                    }
                }
            });
        }

        // ====================================================================
        // DEVICE TREND
        // ====================================================================
        async function renderDeviceTrend() {
            const w = getWhereClause();
            const data = await query(`
                SELECT
                    DATE_TRUNC('month', date)::VARCHAR as month,
                    ROUND(SUM(views_desktop) * 100.0 / NULLIF(SUM(views_desktop) + SUM(views_mobile) + SUM(views_tablet), 0), 1) as desktop_pct,
                    ROUND(SUM(views_mobile) * 100.0 / NULLIF(SUM(views_desktop) + SUM(views_mobile) + SUM(views_tablet), 0), 1) as mobile_pct
                FROM analytics
                WHERE ${w}
                  AND DATE_TRUNC('month', date) < DATE_TRUNC('month', CURRENT_DATE)
                GROUP BY 1 ORDER BY 1
            `);

            destroyChart('chartDeviceTrend');
            const ctx = document.getElementById('chartDeviceTrend').getContext('2d');
            charts['chartDeviceTrend'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(r => r.month.substring(0, 7)),
                    datasets: [
                        {
                            label: 'Desktop %',
                            data: data.map(r => r.desktop_pct),
                            borderColor: '#3498db',
                            tension: 0.3,
                            pointRadius: 3
                        },
                        {
                            label: 'Mobile %',
                            data: data.map(r => r.mobile_pct),
                            borderColor: '#e74c3c',
                            tension: 0.3,
                            pointRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } },
                        x: { ticks: { maxRotation: 45 } }
                    }
                }
            });
        }

        // ====================================================================
        // STALE CONTENT
        // ====================================================================
        async function renderStaleContent() {
            const channelWhere = channelFilterValue ? `AND d.channel = '${channelFilterValue.replace(/'/g, "''")}'` : '';
            const videoWhere = videoSearchValue.length >= 2 ? `AND d.name ILIKE '%${videoSearchValue.replace(/'/g, "''")}%'` : '';
            const data = await query(`
                SELECT
                    d.channel,
                    d.video_id,
                    d.name,
                    d.video_duration_seconds,
                    d.created_at
                FROM dims d
                WHERE d.video_id IN (
                    SELECT video_id
                    FROM facts
                    WHERE dt_last_viewed IS NOT NULL
                    GROUP BY video_id
                    HAVING CAST(MAX(dt_last_viewed) AS DATE) < CURRENT_DATE - INTERVAL '180 days'
                )
                ${channelWhere}
                ${videoWhere}
                ORDER BY d.name
                LIMIT 50
            `);

            if (data.length === 0) {
                document.getElementById('staleContent').innerHTML = '<p style="color:var(--medium-gray);font-size:0.85rem;">No stale content found -- all videos viewed within 180 days.</p>';
                return;
            }

            document.getElementById('staleContent').innerHTML = renderTable(data, [
                { key: 'channel', label: 'Channel' },
                { key: 'name', label: 'Video Name', fmt: v => truncateStr(v, 70) },
                { key: 'video_duration_seconds', label: 'Duration', cls: 'text-right', fmt: fmtDuration },
                { key: 'created_at', label: 'Created', fmt: v => v ? String(v).substring(0, 10) : '-' }
            ]);
        }

        // ====================================================================
        // RECENT PERFORMERS
        // ====================================================================
        async function renderRecentPerformers() {
            const channelWhere = channelFilterValue ? `AND channel = '${channelFilterValue.replace(/'/g, "''")}'` : '';
            const videoWhere = videoSearchValue.length >= 2 ? `AND name ILIKE '%${videoSearchValue.replace(/'/g, "''")}%'` : '';
            const data = await query(`
                SELECT
                    channel,
                    video_id,
                    MAX(name) as name,
                    SUM(video_view) as views,
                    ROUND(SUM(video_engagement_100) * 100.0 / NULLIF(SUM(video_view), 0), 1) as completion
                FROM analytics
                WHERE date >= CURRENT_DATE - INTERVAL '30 days'
                  AND video_view > 0
                  ${channelWhere}
                  ${videoWhere}
                GROUP BY channel, video_id
                ORDER BY views DESC
                LIMIT 20
            `);

            document.getElementById('recentPerformers').innerHTML = renderTable(data, [
                { key: 'channel', label: 'Channel' },
                { key: 'name', label: 'Video Name', fmt: v => truncateStr(v, 70) },
                { key: 'views', label: 'Views (30d)', cls: 'text-right', fmt: fmt },
                { key: 'completion', label: 'Completion', cls: 'text-right', fmt: fmtPct }
            ]);
        }

        // ====================================================================
        // EXPLORE TAB
        // ====================================================================
        async function populateChannelFilter() {
            const data = await query(`SELECT DISTINCT channel FROM dims WHERE channel IS NOT NULL ORDER BY channel`);
            allChannels = data.map(r => r.channel);
            const select = document.getElementById('channelFilter');
            const current = select.value;
            select.innerHTML = '<option value="">All Channels</option>' +
                allChannels.map(ch => `<option value="${ch}"${ch === current ? ' selected' : ''}>${ch}</option>`).join('');
        }

        async function renderExploreTable() {
            const w = getWhereClause();
            const data = await query(`
                SELECT
                    channel,
                    video_id,
                    MAX(name) as name,
                    SUM(video_view) as views,
                    ROUND(SUM(video_engagement_100) * 100.0 / NULLIF(SUM(video_view), 0), 1) as completion,
                    ROUND(MAX(video_duration_seconds), 0) as duration_sec
                FROM analytics
                WHERE ${w} AND video_view > 0
                GROUP BY channel, video_id
                ORDER BY views DESC
                LIMIT 100
            `);

            document.getElementById('exploreTable').innerHTML = renderTable(data, [
                { key: 'channel', label: 'Channel' },
                { key: 'name', label: 'Video Name', fmt: v => truncateStr(v, 80) },
                { key: 'views', label: 'Views', cls: 'text-right', fmt: fmt },
                { key: 'completion', label: 'Completion', cls: 'text-right', fmt: fmtPct },
                { key: 'duration_sec', label: 'Duration', cls: 'text-right', fmt: fmtDuration }
            ]);
        }

        // ====================================================================
        // TABLE RENDERER
        // ====================================================================
        function renderTable(data, columns) {
            if (!data || data.length === 0) {
                return '<p style="color:var(--medium-gray);font-size:0.85rem;">No data available.</p>';
            }

            const header = columns.map(col =>
                `<th class="${col.cls || ''}">${col.label}</th>`
            ).join('');

            const rows = data.map(row =>
                '<tr>' + columns.map(col => {
                    const val = row[col.key];
                    const display = col.fmt ? col.fmt(val) : (val != null ? val : '-');
                    return `<td class="${col.cls || ''}">${display}</td>`;
                }).join('') + '</tr>'
            ).join('');

            return `
                <div class="table-container">
                    <table>
                        <thead><tr>${header}</tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }

        // ====================================================================
        // START
        // ====================================================================
        init();
    </script>
</body>
</html>
